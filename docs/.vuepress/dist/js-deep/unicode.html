<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>字符集与编码 | Jmingzi</title>
    <meta name="description" content="为什么是字符集编码而不是字符编码呢？看完本文后你会有一个清晰的理解">
    <meta http-equiv="Cache-Control" content="no-transform">
  <meta name="google-site-verification" content="TbvyCK9sEBOqr5fAbXQ2uLNMgTDgn4wmpBM747LhOwk">
  <meta name="baidu-site-verification" content="mqWodOmELg">
    <meta name="keywords" content="ASCII码，Unicode字符集，码点与编码，js字符集与编码，高级前端进阶之路">
    <link rel="preload" href="/assets/css/0.styles.69aad005.css" as="style"><link rel="preload" href="/assets/js/app.8a56bb21.js" as="script"><link rel="preload" href="/assets/js/2.0a837319.js" as="script"><link rel="preload" href="/assets/js/12.adbaf27e.js" as="script"><link rel="preload" href="/assets/js/4.248ce40c.js" as="script"><link rel="prefetch" href="/assets/js/10.41a3a51a.js"><link rel="prefetch" href="/assets/js/11.76fa4185.js"><link rel="prefetch" href="/assets/js/13.baf1b0e4.js"><link rel="prefetch" href="/assets/js/3.46aa42ee.js"><link rel="prefetch" href="/assets/js/5.fc456d11.js"><link rel="prefetch" href="/assets/js/6.993924a1.js"><link rel="prefetch" href="/assets/js/7.b82ca16b.js"><link rel="prefetch" href="/assets/js/8.3a92415e.js"><link rel="prefetch" href="/assets/js/9.f167b5a8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.69aad005.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://avatars0.githubusercontent.com/u/9743418?s=460&amp;v=4" alt="Jmingzi" class="logo"> <span class="site-name can-hide">Jmingzi</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://iming.work/demo/upload/dist/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  图床工具
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://iming.work" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/jmingzi/vuepress-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://iming.work/demo/upload/dist/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  图床工具
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://iming.work" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/jmingzi/vuepress-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">首页</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Js 深入系列</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/js-deep/float-number.html" class="sidebar-link">理解浮点数</a></li><li><a href="/js-deep/unicode.html" class="active sidebar-link">字符集与编码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js-deep/unicode.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/js-deep/unicode.html#ascii码" class="sidebar-link">ASCII码</a></li><li class="sidebar-sub-header"><a href="/js-deep/unicode.html#字符与字节" class="sidebar-link">字符与字节</a></li><li class="sidebar-sub-header"><a href="/js-deep/unicode.html#字节与二进制、八进制与十六进制的关系" class="sidebar-link">字节与二进制、八进制与十六进制的关系</a></li><li class="sidebar-sub-header"><a href="/js-deep/unicode.html#unicode字符集、码点与编码" class="sidebar-link">Unicode字符集、码点与编码</a></li><li class="sidebar-sub-header"><a href="/js-deep/unicode.html#utf-16编码与字节序" class="sidebar-link">utf-16编码与字节序</a></li><li class="sidebar-sub-header"><a href="/js-deep/unicode.html#utf-8编码" class="sidebar-link">utf-8编码</a></li><li class="sidebar-sub-header"><a href="/js-deep/unicode.html#ucs-2编码" class="sidebar-link">ucs-2编码</a></li><li class="sidebar-sub-header"><a href="/js-deep/unicode.html#js使用的编码" class="sidebar-link">js使用的编码</a></li><li class="sidebar-sub-header"><a href="/js-deep/unicode.html#es6的unicode支持" class="sidebar-link">ES6的Unicode支持</a></li><li class="sidebar-sub-header"><a href="/js-deep/unicode.html#结语" class="sidebar-link">结语</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>ES6 系列</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/es6/iterate.html" class="sidebar-link">迭代器</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="字符集与编码"><a href="#字符集与编码" class="header-anchor">#</a> 字符集与编码</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>为什么是字符集编码而不是字符编码呢？看完本文后你会有一个清晰的理解。本文讲述的内容：</p> <ul><li>ASCII码</li> <li>字符与字节</li> <li>字节与二进制、八进制与十六进制的关系</li> <li>Unicode字符集、码点与编码</li> <li>utf-16编码与字节序</li> <li>utf-8编码</li> <li>ucs-2编码</li> <li>js使用的编码</li> <li>ES6的Unicode支持</li></ul> <h2 id="ascii码"><a href="#ascii码" class="header-anchor">#</a> ASCII码</h2> <p>讲编码的概念，当然得从计算机的起源开始说起了，就好比每当说到中国神话故事，都得从盘古开天的时候讲述一样。</p> <p>美国人发明的计算机，那当然最开始的编码是从英文字母开始的，此时的编码是处理英文字母、数字、符号与二进制的对应关系，数量不多，128个足够表示全部了。此时，这128个对应关系的定义所得到的编码就被称为ASCII码。</p> <h2 id="字符与字节"><a href="#字符与字节" class="header-anchor">#</a> 字符与字节</h2> <p>字符与字节在我的上一篇文章有提及，字符是什么呢，字符就是我们在计算机上说看到的，比如<code>'a', '你', 👿</code>等等。</p> <p>对于ASCII码，上节提到128种编码分别对应128个字符，这被称为单字节字符，也就是说一个字符代表占用一个字节。</p> <p>对于非单字节字符，像<code>emoji</code>表情，是4个字节组成（为什么是4个后面会说）。也就是说，一个字符可能由多个字节组成，这依赖于对应的编码方式。</p> <h2 id="字节与二进制、八进制与十六进制的关系"><a href="#字节与二进制、八进制与十六进制的关系" class="header-anchor">#</a> 字节与二进制、八进制与十六进制的关系</h2> <p>1个字节由8位二进制组成，总共对应<code>0000 0000</code> ~ <code>1111 1111</code>256种状态。前面说的<code>ASCII码</code>就
是其中的<code>0000 0000</code> ~ <code>0111 1111</code>128种。</p> <p>我们知道十六进制是用<code>0-9 a-f</code>来表示，最大15用二进制来表示即<code>1111</code>，由于1个字节有8位，所以需要2个十六进制数才能代表一个字节，即<code>00</code> ~ <code>ff</code>才能代表一个字节的范围。</p> <p>那八进制与字节的关系如何呢？</p> <p>八进制最大为7，即<code>111</code>，我们会发现需要3位八进制才能表示一个字节<code>111 111 111</code>，但是又多了一位，此时该如何解释？我没弄懂。。。⚠️</p> <p>在js中，普通的书写数字一般都是十进制的格式，如果在数字前加<code>0</code>，则代表八进制数，加<code>0x</code>，代表十六进制数。</p> <p>进制的互相转换只需要讲对应的数字转换成相应的进制来表示，比如十进制<code>110</code>:</p> <ul><li>转换为二进制
<ul><li>转换过程为100转化为二进制 <code>(100).toString(2)</code> <code>1100100</code></li> <li>10转化为二进制 <code>1010</code></li> <li>结合起来就是<code>1101110</code></li></ul></li> <li>转化为八进制
<ul><li>转换过程为100转化为八进制 <code>(100).toString(8)</code> <code>144</code></li> <li>10转化为八进制 <code>12</code></li> <li>结合起来就是<code>156</code></li></ul></li> <li>同理转化为十六进制</li></ul> <p>计算机内都是以二进制的形式存储，八进制与十六进制其实只是人们对二进制的一种简化写法，因为当数值越来越大时，书写起来，会需要很长很长，为了方便使用，就新增了八进制与十六进制等表现形式。</p> <h2 id="unicode字符集、码点与编码"><a href="#unicode字符集、码点与编码" class="header-anchor">#</a> Unicode字符集、码点与编码</h2> <p>我们上面说到<code>ASCII码</code>只是代表了二进制8位中的前7位127个字符，在<code>Unicode</code>还未诞生之前，各个国家是自己编码对应的字符，例如我国就有<code>gb2312</code>，2个字节对应一个字符，具体不深入。</p> <p>汉字就有好几万，再加上世界上这么多语言，为了统一字符编码，<code>Unicode</code>就应运而生了，计算机只使用这一种字符集，就不会出现乱码了。</p> <p>码点<code>Code Point</code>组成了<code>Unicode</code>的字符集，码点的表示法是<code>U+0000</code>即4位十六进制，那它代表的字符范围是<code>0000</code> ~ <code>ffff</code>共65535个。</p> <p><strong>我们要着重理解的是，<code>Unicode</code>字符集不是编码，即没有规定多字节字符如何存储，而实现这种存储的方式是utf-8和utf-16等</strong>。</p> <p><strong>BMP/SMP</strong></p> <p><code>Unicode</code>的码点范围是<code>U+0000</code> ~ <code>U+10ffff</code>，前面说到的<code>U+0000</code> ~ <code>U+ffff</code>共65535代表BMP基本平面，最常见字符都在这个范围内，我们知道2个十六进制代表一个字节，那基本平面的字符都是由2个字节组合表示的。</p> <p>基本平面以外的，<code>U+010000</code> ~ <code>U+10ffff</code>共<code>0x10</code>16个平面称为补充平面SMP，用来表示常见字符以外的字符，例如emoji表情。</p> <p><code>Unicode</code>共代表了<code>U+10ffff</code>110万多个字符。</p> <h2 id="utf-16编码与字节序"><a href="#utf-16编码与字节序" class="header-anchor">#</a> utf-16编码与字节序</h2> <p><code>Unicode</code>是采用十六进制来表示的，那一个utf-16编码的字符看起来就是这样的<code>0x597d</code>和<code>Unicode</code>差不多，一个是<code>u+</code>，另一个是<code>0x</code>，在js中，用<code>\u</code>表示。</p> <p>例如，汉字<code>我</code>的十六进制编码:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'我'</span><span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 基本平面内对应unicode的码点</span>
<span class="token comment">// 25105</span>

<span class="token punctuation">(</span><span class="token number">25105</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment">// 转换为16进制</span>
<span class="token comment">// &quot;6211&quot;</span>
</code></pre></div><p>对应的十六进制编码为'0x6211'，也就是说<code>'\u6211' === '我'</code></p> <p>那计算机为啥知道6211就是字符“我”而不是1162，因为62和11是2个字节，这就涉及到了<strong>字节序</strong>的问题，也就是我们说的文件BOM头。</p> <p>有2个术语<code>Big endian</code>和<code>Little endian</code>，称为“大头”和“小头”，这里可以理解为62是大头，11是小头。</p> <blockquote><p>Unicode 规范定义，每一个文件的最前面分别加入一个表示编码顺序的字符，这个字符的名字叫做&quot;零宽度非换行空格&quot;（zero width no-break space），用FEFF表示。这正好是两个字节，而且FF比FE大1。</p> <p>如果一个文本文件的头两个字节是FE FF，就表示该文件采用大头方式；如果头两个字节是FF FE，就表示该文件采用小头方式。</p></blockquote> <hr> <p>上面字符“我”在基本平面是2个字节表示，那么补充平面的内的字符是几个呢？答案是4个字节，为什么这么说呢？</p> <p>当码点大于<code>U+ffff</code>的字符求长度时：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">🐷</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span>length <span class="token comment">// 2</span>
</code></pre></div><p>这说明SMP补充平面的字符是由2个BMP基本平面的字符组成，因为基本平面的一个字符长度就是1。而基本平面的字符由2个字节组成，那补充平面很显然是4个字节组成了。</p> <p>上面我们说unicode和十六进制表现形式只有前面符号的区别，其实它们之间是有转码公式对应的：</p> <ul><li>基本平面<div class="language-js extra-class"><pre class="language-js"><code>u<span class="token operator">+</span><span class="token number">597</span>d <span class="token operator">=</span> <span class="token number">0x597d</span>
</code></pre></div></li> <li>补充平面<div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">H</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>码点<span class="token operator">-</span><span class="token number">0x10000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0x400</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0xD800</span>
<span class="token constant">L</span> <span class="token operator">=</span> <span class="token punctuation">(</span>码点 <span class="token operator">-</span> <span class="token number">0x10000</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0x400</span> <span class="token operator">+</span> <span class="token number">0xDC00</span>
</code></pre></div></li></ul> <p>求码点</p> <ul><li>基本平面 <code>charCodeAt()</code></li> <li>补充平面 <code>codePointAt()</code></li></ul> <p>例如<code>🐷</code>这个emoji表情求码点</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'🐷'</span><span class="token punctuation">.</span><span class="token function">codePointAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">// 128055 </span>
<span class="token comment">// 转为十六进制后再带入公式</span>
<span class="token comment">// (128055).toString(16) = '1f437' </span>
<span class="token comment">// 那么高位H和低位L分别为</span>
<span class="token keyword">const</span> <span class="token constant">H</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0x1f437</span><span class="token operator">-</span><span class="token number">0x10000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0x400</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0xD800</span>
<span class="token comment">// d83d</span>
<span class="token keyword">const</span> <span class="token constant">L</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0x1f437</span> <span class="token operator">-</span> <span class="token number">0x10000</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0x400</span> <span class="token operator">+</span> <span class="token number">0xDC00</span>
<span class="token comment">// dc37</span>
<span class="token string">'\ud83d\udc37'</span> <span class="token operator">===</span> <span class="token string">'🐷'</span>
<span class="token comment">// true</span>
</code></pre></div><p>从上面的栗子中，我们可以进一步说明SMP的字符是由4个字节组成的。</p> <p>那计算机如何知道这4个字节放在一起就是SMP的字符而不是2个BMP的字符呢？</p> <p>其实高位H和低位L在BMP中也是有对应关系的：</p> <ul><li>高位H的范围是 <code>0xd800</code> ~ <code>0xdbff</code>，空间大小为2^10 = 1024</li> <li>低位L的范围是 <code>0xdc00</code> ~ <code>0xdfff</code>，空间大小为2^10 = 1024</li></ul> <p>那组合起来的总空间为2^20 = 1048576，这恰恰和SMP平面范围<code>U+010000</code> ~ <code>U+10ffff</code>所表示的范围一致，即<code>0x10ffff - 0x010000 = 1048575</code></p> <p>所以，当我们取长度时，可以匹配基本平面的高位和低位段，从而判断是否是SMP字符，进一步处理长度。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> regexAstralSymbols <span class="token operator">=</span> <span class="token regex">/[\uD800-\uDBFF][\uDC00-\uDFFF]/g</span>

<span class="token keyword">function</span> <span class="token function">countSymbols</span><span class="token punctuation">(</span><span class="token parameter">_string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> bmpString <span class="token operator">=</span> _string<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>regexAstralSymbols<span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> bmpString<span class="token punctuation">.</span>length
<span class="token punctuation">}</span>

<span class="token function">countSymbols</span><span class="token punctuation">(</span><span class="token string">'🐷'</span><span class="token punctuation">)</span>
<span class="token comment">// 1</span>
</code></pre></div><h2 id="utf-8编码"><a href="#utf-8编码" class="header-anchor">#</a> utf-8编码</h2> <p>UTF-8 就是在互联网上使用最广的一种 Unicode 的实现方式，使用可变字节来标示BMP、SMP 的字符。</p> <p>unicode与utf-8也有一套对照关系</p> <table><thead><tr><th>unicode</th> <th>utf-8</th></tr></thead> <tbody><tr><td>0000 - 007F</td> <td>0xxxxxxx</td></tr> <tr><td>0080 - 07FF</td> <td>110xxxxx 10xxxxxx</td></tr> <tr><td>0800 - FFFF</td> <td>1110xxxx 10xxxxxx 10xxxxxx</td></tr></tbody></table> <p>例如，“我”字的unicode码点为“6211”</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'我'</span><span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
<span class="token comment">// &quot;6211&quot;</span>
</code></pre></div><p>由于<code>0x6211 &gt; 0x0800</code>的，所以对应的utf-8为3个字节，将<code>6211</code>转成二进制为:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// (0x6211).toString(2)</span>
<span class="token number">0110</span> <span class="token number">0010</span> <span class="token number">0001</span> <span class="token number">0001</span>
</code></pre></div><p>用对应的模版补齐则是：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token number">11100110</span> <span class="token number">10001000</span> <span class="token number">10010001</span>
<span class="token comment">// e  6     8  8    9   1  </span>
<span class="token comment">// 四位二进制代表一位十六进制</span>
</code></pre></div><p>这就得到了“我”字的utf-8编码，转成十六进制<code>e68891</code>。</p> <h2 id="ucs-2编码"><a href="#ucs-2编码" class="header-anchor">#</a> ucs-2编码</h2> <p>在js语言还未诞生之前，ucs-2就已经发布了，它只支持2个字节组成的字符，并不支持4个，因为在涉及之初认为已经够用了，鬼想到还会出现类似emoji这样的东西。</p> <p>发展历史</p> <ul><li>ucs-2发布</li> <li>js诞生</li> <li>js解释器引擎诞生</li> <li>utf-16发布</li></ul> <p>也就是说ucs-2是不支持由4个字节也就是SMP平面的字符。理所当然的在BMP中也不会存在高位和低位码点段来映射SMP。</p> <p>但是utf-16是完全兼容ucs-2的。那js到底是使用的utf-16还是ucs-2呢？</p> <h2 id="js使用的编码"><a href="#js使用的编码" class="header-anchor">#</a> js使用的编码</h2> <p><strong>1. 对js文件解析时</strong></p> <p>js在编译前需要将文件中的内容按照一定的编码读取成字符串</p> <p>解码使用的编码方案按优先级高到低由下面几个方面来决定：</p> <ul><li>如果文件有BOM 标记，则会使用对应的Unicode 编码，比如FFFE、FEFF 就会使用UTF-16。这就是上面提到的“大头”“小头”定义的文件字节序。</li> <li>由HTTP(S)请求的相应头来决定，比如：<br> <code>Content-Type: application/javascript; charset=utf-8</code></li> <li>由<script></script> 标签的charset 属性决定，比如：<br> <code>&lt;script charset=&quot;utf-8&quot; src=&quot;./main.js&quot;&gt;&lt;/script&gt;</code></li> <li>由html 本身的charset 决定，比如：<br> <code>&lt;meta charset=&quot;UTF-8&quot;&gt;</code></li></ul> <p>此处复制于<a href="https://github.com/SamHwang1990/blog/issues/2" target="_blank" rel="noopener noreferrer">Javascript 与字符编码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><strong>2. 编译与运行时</strong></p> <p>Javascript 引擎总会尝试把源码转成UTF-16 编码的文本，对于这个定义的探究，便只能查看官方定义，此处参考<a href="https://github.com/SamHwang1990/blog/issues/2" target="_blank" rel="noopener noreferrer">Javascript 与字符编码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>总结来说，js语言本身采用UCS-2来实现这是事实</p> <ul><li>编译时现在的引擎都会采用utf-16</li> <li>运行时可能既有ucs-2，又有utf-16</li></ul> <p>过分去深究这个问题似乎没有多少意义，因为二者所表现的特性都是utf-16所表现的。</p> <h2 id="es6的unicode支持"><a href="#es6的unicode支持" class="header-anchor">#</a> ES6的Unicode支持</h2> <p>我们先来看看unicode的坑</p> <h3 id="_1-对于smp字符获取长度为2上面已经提到了"><a href="#_1-对于smp字符获取长度为2上面已经提到了" class="header-anchor">#</a> 1. 对于SMP字符获取长度为2上面已经提到了</h3> <h3 id="_2-字符串的反转"><a href="#_2-字符串的反转" class="header-anchor">#</a> 2. 字符串的反转</h3> <p>正常情况下，反转一个字符串</p> <div class="language-js extra-class"><pre class="language-js"><code>str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
</code></pre></div><p>那遇到SMP字符就肯定错了，因为它会将SMP字符的2个十六进制对也反转了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'🐷'</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
<span class="token comment">// &quot;��&quot;</span>
</code></pre></div><h3 id="_3-字符与码点的互转"><a href="#_3-字符与码点的互转" class="header-anchor">#</a> 3. 字符与码点的互转</h3> <p>在BMP范围内，互转是没有问题的</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'我'</span><span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment">// 6211</span>
String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span><span class="token number">0x6211</span><span class="token punctuation">)</span> <span class="token comment">// 我</span>
</code></pre></div><p>但是SMP就不行了，取码点要将2个十六进制对都取出来</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'💩'</span><span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment">// d83d </span>
<span class="token string">'💩'</span><span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment">// dca9</span>

<span class="token comment">// 同样的反转时也是一样</span>
String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span><span class="token number">0xD83D</span><span class="token punctuation">,</span> <span class="token number">0xDCA9</span><span class="token punctuation">)</span> <span class="token comment">// '💩'</span>
</code></pre></div><h3 id="_4-正则匹配"><a href="#_4-正则匹配" class="header-anchor">#</a> 4. 正则匹配</h3> <p>正则匹配符<code>.</code>只能匹配单个“字符”，那很明显SMP字符是匹配不到的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token regex">/foo.bar/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'foo💩bar'</span><span class="token punctuation">)</span> <span class="token comment">// false</span>
</code></pre></div><h3 id="_5-字符串遍历"><a href="#_5-字符串遍历" class="header-anchor">#</a> 5. 字符串遍历</h3> <p>这也是一个很明显的问题，比较直接的办法是：</p> <p>遍历字符串，用<code>charCodeAt</code>转成码点后存放进临时数组，然后再遍历这个由码点组成的临时数组，判断码点在高位和低位段的认为是SMP对应的码点映射。</p> <hr> <h3 id="针对上述问题，es6填坑了"><a href="#针对上述问题，es6填坑了" class="header-anchor">#</a> 针对上述问题，es6填坑了</h3> <ul><li>长度问题还是需要用正则匹配高位和低位码点，将对应的字符替换为BMP中的任意字符即可。</li> <li>字符串的反转，可以使用<code>Array.from()</code><div class="language-js extra-class"><pre class="language-js"><code>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'这是一坨💩'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
<span class="token comment">// &quot;💩坨一是这&quot;</span>
</code></pre></div></li> <li>码点的互转，使用<code>codePointAt</code>和<code>fromCodePoint</code><div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'我'</span><span class="token punctuation">.</span><span class="token function">codePointAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment">// 6211</span>
<span class="token string">'💩'</span><span class="token punctuation">.</span><span class="token function">codePointAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment">// 1f4a9</span>
String<span class="token punctuation">.</span><span class="token function">fromCodePoint</span><span class="token punctuation">(</span><span class="token number">0x1f4a9</span><span class="token punctuation">)</span> <span class="token comment">// &quot;💩&quot;</span>
</code></pre></div></li> <li>正则匹配<div class="language-js extra-class"><pre class="language-js"><code><span class="token regex">/foo.bar/u</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'foo💩bar'</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
</code></pre></div></li> <li>字符串遍历 <code>let ... of</code></li></ul> <h2 id="结语"><a href="#结语" class="header-anchor">#</a> 结语</h2> <p>我们再回过头来看最初问的问题，为什么是字符集编码而不是字符。很显然，字符是编码后我们看到的结果，而不是要编码的内容，从最初的<code>ASCII码</code>字符集，<code>UCS</code>字符集，再到<code>Unicode</code>字符集，它们都是一种统一集合，而实现字符集编码的方式有多种：<code>ucs-2</code>，<code>utf-16</code>，<code>utf-8</code>等等，我们讲编码方式，一定是讲的它们。</p> <div style="margin-top:50px;"><p style="font-weight: bold;">
      全文结束！
      <a href="https://github.com/Jmingzi/vuepress-blog/issues/new" target="_blank">文章有错误去纠正 →</a></p> <div style="text-align: center;border-top: 3px dashed #ccc;"><img width="500px" src="/assets/img/footer.47a9ee53.jpg" alt="关注公众号：高级前端进阶之路。一起成长！"></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">12/21/2019, 1:12:45 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/js-deep/float-number.html" class="prev">理解浮点数</a></span> <span class="next"><a href="/es6/iterate.html">迭代器</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.8a56bb21.js" defer></script><script src="/assets/js/2.0a837319.js" defer></script><script src="/assets/js/12.adbaf27e.js" defer></script><script src="/assets/js/4.248ce40c.js" defer></script>
  </body>
</html>
